---
title: LPIC201/202 あずき本 ch13 SMTPサーバの構築
tags:
- LPIC202
- 勉強メモ
- 資格勉強
- SMTP
- POP
- IMAP
date: 2021-01-04T22:00:00+09:00
bibliography: https://www.shoeisha.co.jp/book/detail/9784798151250
---


# 13.1 SMTPサーバの構築 #

## 13.1.1 メール配送の仕組み ##

Message~ の略とすることも

- MTA: Mail Transfer Agent
  - DNSに問い合わせて配送先MTAへメール転送(リレー)
  - SMTPサーバとも
  - 代表例: Postfix, sendmail, exim
- MDA: Mail Delivery Agent
  - メールサーバ内で宛先ユーザのメールボックスにメール配送・格納
  - 代表例: procmail
- MUA: Mail User Agent
  - MTAにメールを差し出す
  - POP/IMAPサーバを経由してメールを取り出す
- POP/IMAPサーバ
  - MUAがメール受信するときに使用するプロトコル
  - 代表例: Dovecot, Courier Mail Server
- メールボックス
  - mbox形式: `/var/mail/` に1ユーザ1ファイル
  - Maildir形式: `~user/` に1メール1ファイル



## 13.1.2 Postfixの概要 ##

Postfixのアーキテクチャ: http://www.postfix.org/OVERVIEW.html

```sh
ps auxw | grep postfix
```

```
root      1071  0.0  0.2  91788  2164 ?        Ss   13:03   0:00 /usr/libexec/postfix/master -w
postfix   1096  0.0  0.4  91892  4064 ?        S    13:03   0:00 pickup -l -t unix -u
postfix   1097  0.0  0.4  91960  4088 ?        S    13:03   0:00 qmgr -l -t unix -u
wand      1313  0.0  0.0 112780   684 pts/0    S+   13:18   0:00 grep --color=auto postfix
```

複数のプロセスからなる

- sendmail
  - sendmail互換インタフェース
- smtpd
  - MTU -> MTU の外部配送(リレー)を処理
- pickup
  - maildropキューを監視、内部配送を処理
- cleanup
  - incomingキューにpushし、qmgrに通知する
- qmgr
  - キュー内のメールを配送プログラムに渡す
- nqmgr
  - qmgrと同じだが配送アルゴリズムが異なる
- master
  - 全体制御
- bounce
  - バウンスメール処理


## 13.1.3 Postfixの設定 ##

```sh
ls /etc/postfix/
```

```
access	canonical  generic  header_checks  main.cf  master.cf  relocated  transport  virtual
```

- main.cf: MTAの設定
- master.cf: 各種デーモンの設定


### main.cfの設定 ###

``` sh
cat /etc/postfix/main.cf
```

```
# Global Postfix configuration file. This file lists only a subset
# of all parameters. For the syntax, and for a complete parameter
# list, see the postconf(5) manual page (command: "man 5 postconf").
#
# For common configuration examples, see BASIC_CONFIGURATION_README
# and STANDARD_CONFIGURATION_README. To find these documents, use
# the command "postconf html_directory readme_directory", or go to
# http://www.postfix.org/.
#
# For best results, change no more than 2-3 parameters at a time,
# and test if Postfix still works after every change.

# SOFT BOUNCE
#
# The soft_bounce parameter provides a limited safety net for
# testing.  When soft_bounce is enabled, mail will remain queued that
# would otherwise bounce. This parameter disables locally-generated
# bounces, and prevents the SMTP server from rejecting mail permanently
# (by changing 5xx replies into 4xx replies). However, soft_bounce
# is no cure for address rewriting mistakes or mail routing mistakes.
#
#soft_bounce = no

# LOCAL PATHNAME INFORMATION
#
# The queue_directory specifies the location of the Postfix queue.
# This is also the root directory of Postfix daemons that run chrooted.
# See the files in examples/chroot-setup for setting up Postfix chroot
# environments on different UNIX systems.
#
queue_directory = /var/spool/postfix

# The command_directory parameter specifies the location of all
# postXXX commands.
#
command_directory = /usr/sbin

# The daemon_directory parameter specifies the location of all Postfix
# daemon programs (i.e. programs listed in the master.cf file). This
# directory must be owned by root.
#
daemon_directory = /usr/libexec/postfix

# The data_directory parameter specifies the location of Postfix-writable
# data files (caches, random numbers). This directory must be owned
# by the mail_owner account (see below).
#
data_directory = /var/lib/postfix

# QUEUE AND PROCESS OWNERSHIP
#
# The mail_owner parameter specifies the owner of the Postfix queue
# and of most Postfix daemon processes.  Specify the name of a user
# account THAT DOES NOT SHARE ITS USER OR GROUP ID WITH OTHER ACCOUNTS
# AND THAT OWNS NO OTHER FILES OR PROCESSES ON THE SYSTEM.  In
# particular, don't specify nobody or daemon. PLEASE USE A DEDICATED
# USER.
#
mail_owner = postfix

# The default_privs parameter specifies the default rights used by
# the local delivery agent for delivery to external file or command.
# These rights are used in the absence of a recipient user context.
# DO NOT SPECIFY A PRIVILEGED USER OR THE POSTFIX OWNER.
#
#default_privs = nobody

# INTERNET HOST AND DOMAIN NAMES
# 
# The myhostname parameter specifies the internet hostname of this
# mail system. The default is to use the fully-qualified domain name
# from gethostname(). $myhostname is used as a default value for many
# other configuration parameters.
#
#myhostname = host.domain.tld
#myhostname = virtual.domain.tld

# The mydomain parameter specifies the local internet domain name.
# The default is to use $myhostname minus the first component.
# $mydomain is used as a default value for many other configuration
# parameters.
#
#mydomain = domain.tld

# SENDING MAIL
# 
# The myorigin parameter specifies the domain that locally-posted
# mail appears to come from. The default is to append $myhostname,
# which is fine for small sites.  If you run a domain with multiple
# machines, you should (1) change this to $mydomain and (2) set up
# a domain-wide alias database that aliases each user to
# user@that.users.mailhost.
#
# For the sake of consistency between sender and recipient addresses,
# myorigin also specifies the default domain name that is appended
# to recipient addresses that have no @domain part.
#
#myorigin = $myhostname
#myorigin = $mydomain

# RECEIVING MAIL

# The inet_interfaces parameter specifies the network interface
# addresses that this mail system receives mail on.  By default,
# the software claims all active interfaces on the machine. The
# parameter also controls delivery of mail to user@[ip.address].
#
# See also the proxy_interfaces parameter, for network addresses that
# are forwarded to us via a proxy or network address translator.
#
# Note: you need to stop/start Postfix when this parameter changes.
#
#inet_interfaces = all
#inet_interfaces = $myhostname
#inet_interfaces = $myhostname, localhost
inet_interfaces = localhost

# Enable IPv4, and IPv6 if supported
inet_protocols = all

# The proxy_interfaces parameter specifies the network interface
# addresses that this mail system receives mail on by way of a
# proxy or network address translation unit. This setting extends
# the address list specified with the inet_interfaces parameter.
#
# You must specify your proxy/NAT addresses when your system is a
# backup MX host for other domains, otherwise mail delivery loops
# will happen when the primary MX host is down.
#
#proxy_interfaces =
#proxy_interfaces = 1.2.3.4

# The mydestination parameter specifies the list of domains that this
# machine considers itself the final destination for.
#
# These domains are routed to the delivery agent specified with the
# local_transport parameter setting. By default, that is the UNIX
# compatible delivery agent that lookups all recipients in /etc/passwd
# and /etc/aliases or their equivalent.
#
# The default is $myhostname + localhost.$mydomain.  On a mail domain
# gateway, you should also include $mydomain.
#
# Do not specify the names of virtual domains - those domains are
# specified elsewhere (see VIRTUAL_README).
#
# Do not specify the names of domains that this machine is backup MX
# host for. Specify those names via the relay_domains settings for
# the SMTP server, or use permit_mx_backup if you are lazy (see
# STANDARD_CONFIGURATION_README).
#
# The local machine is always the final destination for mail addressed
# to user@[the.net.work.address] of an interface that the mail system
# receives mail on (see the inet_interfaces parameter).
#
# Specify a list of host or domain names, /file/name or type:table
# patterns, separated by commas and/or whitespace. A /file/name
# pattern is replaced by its contents; a type:table is matched when
# a name matches a lookup key (the right-hand side is ignored).
# Continue long lines by starting the next line with whitespace.
#
# See also below, section "REJECTING MAIL FOR UNKNOWN LOCAL USERS".
#
mydestination = $myhostname, localhost.$mydomain, localhost
#mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
#mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain,
#	mail.$mydomain, www.$mydomain, ftp.$mydomain

# REJECTING MAIL FOR UNKNOWN LOCAL USERS
#
# The local_recipient_maps parameter specifies optional lookup tables
# with all names or addresses of users that are local with respect
# to $mydestination, $inet_interfaces or $proxy_interfaces.
#
# If this parameter is defined, then the SMTP server will reject
# mail for unknown local users. This parameter is defined by default.
#
# To turn off local recipient checking in the SMTP server, specify
# local_recipient_maps = (i.e. empty).
#
# The default setting assumes that you use the default Postfix local
# delivery agent for local delivery. You need to update the
# local_recipient_maps setting if:
#
# - You define $mydestination domain recipients in files other than
#   /etc/passwd, /etc/aliases, or the $virtual_alias_maps files.
#   For example, you define $mydestination domain recipients in    
#   the $virtual_mailbox_maps files.
#
# - You redefine the local delivery agent in master.cf.
#
# - You redefine the "local_transport" setting in main.cf.
#
# - You use the "luser_relay", "mailbox_transport", or "fallback_transport"
#   feature of the Postfix local delivery agent (see local(8)).
#
# Details are described in the LOCAL_RECIPIENT_README file.
#
# Beware: if the Postfix SMTP server runs chrooted, you probably have
# to access the passwd file via the proxymap service, in order to
# overcome chroot restrictions. The alternative, having a copy of
# the system passwd file in the chroot jail is just not practical.
#
# The right-hand side of the lookup tables is conveniently ignored.
# In the left-hand side, specify a bare username, an @domain.tld
# wild-card, or specify a user@domain.tld address.
# 
#local_recipient_maps = unix:passwd.byname $alias_maps
#local_recipient_maps = proxy:unix:passwd.byname $alias_maps
#local_recipient_maps =

# The unknown_local_recipient_reject_code specifies the SMTP server
# response code when a recipient domain matches $mydestination or
# ${proxy,inet}_interfaces, while $local_recipient_maps is non-empty
# and the recipient address or address local-part is not found.
#
# The default setting is 550 (reject mail) but it is safer to start
# with 450 (try again later) until you are certain that your
# local_recipient_maps settings are OK.
#
unknown_local_recipient_reject_code = 550

# TRUST AND RELAY CONTROL

# The mynetworks parameter specifies the list of "trusted" SMTP
# clients that have more privileges than "strangers".
#
# In particular, "trusted" SMTP clients are allowed to relay mail
# through Postfix.  See the smtpd_recipient_restrictions parameter
# in postconf(5).
#
# You can specify the list of "trusted" network addresses by hand
# or you can let Postfix do it for you (which is the default).
#
# By default (mynetworks_style = subnet), Postfix "trusts" SMTP
# clients in the same IP subnetworks as the local machine.
# On Linux, this does works correctly only with interfaces specified
# with the "ifconfig" command.
# 
# Specify "mynetworks_style = class" when Postfix should "trust" SMTP
# clients in the same IP class A/B/C networks as the local machine.
# Don't do this with a dialup site - it would cause Postfix to "trust"
# your entire provider's network.  Instead, specify an explicit
# mynetworks list by hand, as described below.
#  
# Specify "mynetworks_style = host" when Postfix should "trust"
# only the local machine.
# 
#mynetworks_style = class
#mynetworks_style = subnet
#mynetworks_style = host

# Alternatively, you can specify the mynetworks list by hand, in
# which case Postfix ignores the mynetworks_style setting.
#
# Specify an explicit list of network/netmask patterns, where the
# mask specifies the number of bits in the network part of a host
# address.
#
# You can also specify the absolute pathname of a pattern file instead
# of listing the patterns here. Specify type:table for table-based lookups
# (the value on the table right-hand side is not used).
#
#mynetworks = 168.100.189.0/28, 127.0.0.0/8
#mynetworks = $config_directory/mynetworks
#mynetworks = hash:/etc/postfix/network_table

# The relay_domains parameter restricts what destinations this system will
# relay mail to.  See the smtpd_recipient_restrictions description in
# postconf(5) for detailed information.
#
# By default, Postfix relays mail
# - from "trusted" clients (IP address matches $mynetworks) to any destination,
# - from "untrusted" clients to destinations that match $relay_domains or
#   subdomains thereof, except addresses with sender-specified routing.
# The default relay_domains value is $mydestination.
# 
# In addition to the above, the Postfix SMTP server by default accepts mail
# that Postfix is final destination for:
# - destinations that match $inet_interfaces or $proxy_interfaces,
# - destinations that match $mydestination
# - destinations that match $virtual_alias_domains,
# - destinations that match $virtual_mailbox_domains.
# These destinations do not need to be listed in $relay_domains.
# 
# Specify a list of hosts or domains, /file/name patterns or type:name
# lookup tables, separated by commas and/or whitespace.  Continue
# long lines by starting the next line with whitespace. A file name
# is replaced by its contents; a type:name table is matched when a
# (parent) domain appears as lookup key.
#
# NOTE: Postfix will not automatically forward mail for domains that
# list this system as their primary or backup MX host. See the
# permit_mx_backup restriction description in postconf(5).
#
#relay_domains = $mydestination

# INTERNET OR INTRANET

# The relayhost parameter specifies the default host to send mail to
# when no entry is matched in the optional transport(5) table. When
# no relayhost is given, mail is routed directly to the destination.
#
# On an intranet, specify the organizational domain name. If your
# internal DNS uses no MX records, specify the name of the intranet
# gateway host instead.
#
# In the case of SMTP, specify a domain, host, host:port, [host]:port,
# [address] or [address]:port; the form [host] turns off MX lookups.
#
# If you're connected via UUCP, see also the default_transport parameter.
#
#relayhost = $mydomain
#relayhost = [gateway.my.domain]
#relayhost = [mailserver.isp.tld]
#relayhost = uucphost
#relayhost = [an.ip.add.ress]

# REJECTING UNKNOWN RELAY USERS
#
# The relay_recipient_maps parameter specifies optional lookup tables
# with all addresses in the domains that match $relay_domains.
#
# If this parameter is defined, then the SMTP server will reject
# mail for unknown relay users. This feature is off by default.
#
# The right-hand side of the lookup tables is conveniently ignored.
# In the left-hand side, specify an @domain.tld wild-card, or specify
# a user@domain.tld address.
# 
#relay_recipient_maps = hash:/etc/postfix/relay_recipients

# INPUT RATE CONTROL
#
# The in_flow_delay configuration parameter implements mail input
# flow control. This feature is turned on by default, although it
# still needs further development (it's disabled on SCO UNIX due
# to an SCO bug).
# 
# A Postfix process will pause for $in_flow_delay seconds before
# accepting a new message, when the message arrival rate exceeds the
# message delivery rate. With the default 100 SMTP server process
# limit, this limits the mail inflow to 100 messages a second more
# than the number of messages delivered per second.
# 
# Specify 0 to disable the feature. Valid delays are 0..10.
# 
#in_flow_delay = 1s

# ADDRESS REWRITING
#
# The ADDRESS_REWRITING_README document gives information about
# address masquerading or other forms of address rewriting including
# username->Firstname.Lastname mapping.

# ADDRESS REDIRECTION (VIRTUAL DOMAIN)
#
# The VIRTUAL_README document gives information about the many forms
# of domain hosting that Postfix supports.

# "USER HAS MOVED" BOUNCE MESSAGES
#
# See the discussion in the ADDRESS_REWRITING_README document.

# TRANSPORT MAP
#
# See the discussion in the ADDRESS_REWRITING_README document.

# ALIAS DATABASE
#
# The alias_maps parameter specifies the list of alias databases used
# by the local delivery agent. The default list is system dependent.
#
# On systems with NIS, the default is to search the local alias
# database, then the NIS alias database. See aliases(5) for syntax
# details.
# 
# If you change the alias database, run "postalias /etc/aliases" (or
# wherever your system stores the mail alias file), or simply run
# "newaliases" to build the necessary DBM or DB file.
#
# It will take a minute or so before changes become visible.  Use
# "postfix reload" to eliminate the delay.
#
#alias_maps = dbm:/etc/aliases
alias_maps = hash:/etc/aliases
#alias_maps = hash:/etc/aliases, nis:mail.aliases
#alias_maps = netinfo:/aliases

# The alias_database parameter specifies the alias database(s) that
# are built with "newaliases" or "sendmail -bi".  This is a separate
# configuration parameter, because alias_maps (see above) may specify
# tables that are not necessarily all under control by Postfix.
#
#alias_database = dbm:/etc/aliases
#alias_database = dbm:/etc/mail/aliases
alias_database = hash:/etc/aliases
#alias_database = hash:/etc/aliases, hash:/opt/majordomo/aliases

# ADDRESS EXTENSIONS (e.g., user+foo)
#
# The recipient_delimiter parameter specifies the separator between
# user names and address extensions (user+foo). See canonical(5),
# local(8), relocated(5) and virtual(5) for the effects this has on
# aliases, canonical, virtual, relocated and .forward file lookups.
# Basically, the software tries user+foo and .forward+foo before
# trying user and .forward.
#
#recipient_delimiter = +

# DELIVERY TO MAILBOX
#
# The home_mailbox parameter specifies the optional pathname of a
# mailbox file relative to a user's home directory. The default
# mailbox file is /var/spool/mail/user or /var/mail/user.  Specify
# "Maildir/" for qmail-style delivery (the / is required).
#
#home_mailbox = Mailbox
#home_mailbox = Maildir/
 
# The mail_spool_directory parameter specifies the directory where
# UNIX-style mailboxes are kept. The default setting depends on the
# system type.
#
#mail_spool_directory = /var/mail
#mail_spool_directory = /var/spool/mail

# The mailbox_command parameter specifies the optional external
# command to use instead of mailbox delivery. The command is run as
# the recipient with proper HOME, SHELL and LOGNAME environment settings.
# Exception:  delivery for root is done as $default_user.
#
# Other environment variables of interest: USER (recipient username),
# EXTENSION (address extension), DOMAIN (domain part of address),
# and LOCAL (the address localpart).
#
# Unlike other Postfix configuration parameters, the mailbox_command
# parameter is not subjected to $parameter substitutions. This is to
# make it easier to specify shell syntax (see example below).
#
# Avoid shell meta characters because they will force Postfix to run
# an expensive shell process. Procmail alone is expensive enough.
#
# IF YOU USE THIS TO DELIVER MAIL SYSTEM-WIDE, YOU MUST SET UP AN
# ALIAS THAT FORWARDS MAIL FOR ROOT TO A REAL USER.
#
#mailbox_command = /some/where/procmail
#mailbox_command = /some/where/procmail -a "$EXTENSION"

# The mailbox_transport specifies the optional transport in master.cf
# to use after processing aliases and .forward files. This parameter
# has precedence over the mailbox_command, fallback_transport and
# luser_relay parameters.
#
# Specify a string of the form transport:nexthop, where transport is
# the name of a mail delivery transport defined in master.cf.  The
# :nexthop part is optional. For more details see the sample transport
# configuration file.
#
# NOTE: if you use this feature for accounts not in the UNIX password
# file, then you must update the "local_recipient_maps" setting in
# the main.cf file, otherwise the SMTP server will reject mail for    
# non-UNIX accounts with "User unknown in local recipient table".
#
# Cyrus IMAP over LMTP. Specify ``lmtpunix      cmd="lmtpd"
# listen="/var/imap/socket/lmtp" prefork=0'' in cyrus.conf.
#mailbox_transport = lmtp:unix:/var/lib/imap/socket/lmtp

# If using the cyrus-imapd IMAP server deliver local mail to the IMAP
# server using LMTP (Local Mail Transport Protocol), this is prefered
# over the older cyrus deliver program by setting the
# mailbox_transport as below:
#
# mailbox_transport = lmtp:unix:/var/lib/imap/socket/lmtp
#
# The efficiency of LMTP delivery for cyrus-imapd can be enhanced via
# these settings.
#
# local_destination_recipient_limit = 300
# local_destination_concurrency_limit = 5
#
# Of course you should adjust these settings as appropriate for the
# capacity of the hardware you are using. The recipient limit setting
# can be used to take advantage of the single instance message store
# capability of Cyrus. The concurrency limit can be used to control
# how many simultaneous LMTP sessions will be permitted to the Cyrus
# message store. 
#
# Cyrus IMAP via command line. Uncomment the "cyrus...pipe" and
# subsequent line in master.cf.
#mailbox_transport = cyrus

# The fallback_transport specifies the optional transport in master.cf
# to use for recipients that are not found in the UNIX passwd database.
# This parameter has precedence over the luser_relay parameter.
#
# Specify a string of the form transport:nexthop, where transport is
# the name of a mail delivery transport defined in master.cf.  The
# :nexthop part is optional. For more details see the sample transport
# configuration file.
#
# NOTE: if you use this feature for accounts not in the UNIX password
# file, then you must update the "local_recipient_maps" setting in
# the main.cf file, otherwise the SMTP server will reject mail for    
# non-UNIX accounts with "User unknown in local recipient table".
#
#fallback_transport = lmtp:unix:/var/lib/imap/socket/lmtp
#fallback_transport =

# The luser_relay parameter specifies an optional destination address
# for unknown recipients.  By default, mail for unknown@$mydestination,
# unknown@[$inet_interfaces] or unknown@[$proxy_interfaces] is returned
# as undeliverable.
#
# The following expansions are done on luser_relay: $user (recipient
# username), $shell (recipient shell), $home (recipient home directory),
# $recipient (full recipient address), $extension (recipient address
# extension), $domain (recipient domain), $local (entire recipient
# localpart), $recipient_delimiter. Specify ${name?value} or
# ${name:value} to expand value only when $name does (does not) exist.
#
# luser_relay works only for the default Postfix local delivery agent.
#
# NOTE: if you use this feature for accounts not in the UNIX password
# file, then you must specify "local_recipient_maps =" (i.e. empty) in
# the main.cf file, otherwise the SMTP server will reject mail for    
# non-UNIX accounts with "User unknown in local recipient table".
#
#luser_relay = $user@other.host
#luser_relay = $local@other.host
#luser_relay = admin+$local
  
# JUNK MAIL CONTROLS
# 
# The controls listed here are only a very small subset. The file
# SMTPD_ACCESS_README provides an overview.

# The header_checks parameter specifies an optional table with patterns
# that each logical message header is matched against, including
# headers that span multiple physical lines.
#
# By default, these patterns also apply to MIME headers and to the
# headers of attached messages. With older Postfix versions, MIME and
# attached message headers were treated as body text.
#
# For details, see "man header_checks".
#
#header_checks = regexp:/etc/postfix/header_checks

# FAST ETRN SERVICE
#
# Postfix maintains per-destination logfiles with information about
# deferred mail, so that mail can be flushed quickly with the SMTP
# "ETRN domain.tld" command, or by executing "sendmail -qRdomain.tld".
# See the ETRN_README document for a detailed description.
# 
# The fast_flush_domains parameter controls what destinations are
# eligible for this service. By default, they are all domains that
# this server is willing to relay mail to.
# 
#fast_flush_domains = $relay_domains

# SHOW SOFTWARE VERSION OR NOT
#
# The smtpd_banner parameter specifies the text that follows the 220
# code in the SMTP server's greeting banner. Some people like to see
# the mail version advertised. By default, Postfix shows no version.
#
# You MUST specify $myhostname at the start of the text. That is an
# RFC requirement. Postfix itself does not care.
#
#smtpd_banner = $myhostname ESMTP $mail_name
#smtpd_banner = $myhostname ESMTP $mail_name ($mail_version)

# PARALLEL DELIVERY TO THE SAME DESTINATION
#
# How many parallel deliveries to the same user or domain? With local
# delivery, it does not make sense to do massively parallel delivery
# to the same user, because mailbox updates must happen sequentially,
# and expensive pipelines in .forward files can cause disasters when
# too many are run at the same time. With SMTP deliveries, 10
# simultaneous connections to the same domain could be sufficient to
# raise eyebrows.
# 
# Each message delivery transport has its XXX_destination_concurrency_limit
# parameter.  The default is $default_destination_concurrency_limit for
# most delivery transports. For the local delivery agent the default is 2.

#local_destination_concurrency_limit = 2
#default_destination_concurrency_limit = 20

# DEBUGGING CONTROL
#
# The debug_peer_level parameter specifies the increment in verbose
# logging level when an SMTP client or server host name or address
# matches a pattern in the debug_peer_list parameter.
#
debug_peer_level = 2

# The debug_peer_list parameter specifies an optional list of domain
# or network patterns, /file/name patterns or type:name tables. When
# an SMTP client or server host name or address matches a pattern,
# increase the verbose logging level by the amount specified in the
# debug_peer_level parameter.
#
#debug_peer_list = 127.0.0.1
#debug_peer_list = some.domain

# The debugger_command specifies the external command that is executed
# when a Postfix daemon program is run with the -D option.
#
# Use "command .. & sleep 5" so that the debugger can attach before
# the process marches on. If you use an X-based debugger, be sure to
# set up your XAUTHORITY environment variable before starting Postfix.
#
debugger_command =
	 PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin
	 ddd $daemon_directory/$process_name $process_id & sleep 5

# If you can't use X, use this to capture the call stack when a
# daemon crashes. The result is in a file in the configuration
# directory, and is named after the process name and the process ID.
#
# debugger_command =
#	PATH=/bin:/usr/bin:/usr/local/bin; export PATH; (echo cont;
#	echo where) | gdb $daemon_directory/$process_name $process_id 2>&1
#	>$config_directory/$process_name.$process_id.log & sleep 5
#
# Another possibility is to run gdb under a detached screen session.
# To attach to the screen sesssion, su root and run "screen -r
# <id_string>" where <id_string> uniquely matches one of the detached
# sessions (from "screen -list").
#
# debugger_command =
#	PATH=/bin:/usr/bin:/sbin:/usr/sbin; export PATH; screen
#	-dmS $process_name gdb $daemon_directory/$process_name
#	$process_id & sleep 1

# INSTALL-TIME CONFIGURATION INFORMATION
#
# The following parameters are used when installing a new Postfix version.
# 
# sendmail_path: The full pathname of the Postfix sendmail command.
# This is the Sendmail-compatible mail posting interface.
# 
sendmail_path = /usr/sbin/sendmail.postfix

# newaliases_path: The full pathname of the Postfix newaliases command.
# This is the Sendmail-compatible command to build alias databases.
#
newaliases_path = /usr/bin/newaliases.postfix

# mailq_path: The full pathname of the Postfix mailq command.  This
# is the Sendmail-compatible mail queue listing command.
# 
mailq_path = /usr/bin/mailq.postfix

# setgid_group: The group for mail submission and queue management
# commands.  This must be a group name with a numerical group ID that
# is not shared with other accounts, not even with the Postfix account.
#
setgid_group = postdrop

# html_directory: The location of the Postfix HTML documentation.
#
html_directory = no

# manpage_directory: The location of the Postfix on-line manual pages.
#
manpage_directory = /usr/share/man

# sample_directory: The location of the Postfix sample configuration files.
# This parameter is obsolete as of Postfix 2.1.
#
sample_directory = /usr/share/doc/postfix-2.10.1/samples

# readme_directory: The location of the Postfix README files.
#
readme_directory = /usr/share/doc/postfix-2.10.1/README_FILES
```

- 膨大なパラメータを設定できる
- 設定値を`$パラメータ名`で参照できる

`postconf`コマンドで設定ファイルの設定表示

- `-n`オプションでデフォルトからの差分を表示できる


``` sh
postconf -n
```

```
alias_database = hash:/etc/aliases
alias_maps = hash:/etc/aliases
command_directory = /usr/sbin
config_directory = /etc/postfix
daemon_directory = /usr/libexec/postfix
data_directory = /var/lib/postfix
debug_peer_level = 2
debugger_command = PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin ddd $daemon_directory/$process_name $process_id & sleep 5
html_directory = no
inet_interfaces = localhost
inet_protocols = all
mail_owner = postfix
mailq_path = /usr/bin/mailq.postfix
manpage_directory = /usr/share/man
mydestination = $myhostname, localhost.$mydomain, localhost
newaliases_path = /usr/bin/newaliases.postfix
queue_directory = /var/spool/postfix
readme_directory = /usr/share/doc/postfix-2.10.1/README_FILES
sample_directory = /usr/share/doc/postfix-2.10.1/samples
sendmail_path = /usr/sbin/sendmail.postfix
setgid_group = postdrop
unknown_local_recipient_reject_code = 550
```

指定のパラメータ表示

``` sh
postconf mydomain
```

```
mydomain = localdomain
```

### master.cfの設定 ###

``` sh
cat /etc/postfix/master.cf
```

```
#
# Postfix master process configuration file.  For details on the format
# of the file, see the master(5) manual page (command: "man 5 master").
#
# Do not forget to execute "postfix reload" after editing this file.
#
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (yes)   (never) (100)
# ==========================================================================
smtp      inet  n       -       n       -       -       smtpd
#smtp      inet  n       -       n       -       1       postscreen
#smtpd     pass  -       -       n       -       -       smtpd
#dnsblog   unix  -       -       n       -       0       dnsblog
#tlsproxy  unix  -       -       n       -       0       tlsproxy
#submission inet n       -       n       -       -       smtpd
#  -o syslog_name=postfix/submission
#  -o smtpd_tls_security_level=encrypt
#  -o smtpd_sasl_auth_enable=yes
#  -o smtpd_reject_unlisted_recipient=no
#  -o smtpd_client_restrictions=$mua_client_restrictions
#  -o smtpd_helo_restrictions=$mua_helo_restrictions
#  -o smtpd_sender_restrictions=$mua_sender_restrictions
#  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
#  -o milter_macro_daemon_name=ORIGINATING
#smtps     inet  n       -       n       -       -       smtpd
#  -o syslog_name=postfix/smtps
#  -o smtpd_tls_wrappermode=yes
#  -o smtpd_sasl_auth_enable=yes
#  -o smtpd_reject_unlisted_recipient=no
#  -o smtpd_client_restrictions=$mua_client_restrictions
#  -o smtpd_helo_restrictions=$mua_helo_restrictions
#  -o smtpd_sender_restrictions=$mua_sender_restrictions
#  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
#  -o milter_macro_daemon_name=ORIGINATING
#628       inet  n       -       n       -       -       qmqpd
pickup    unix  n       -       n       60      1       pickup
cleanup   unix  n       -       n       -       0       cleanup
qmgr      unix  n       -       n       300     1       qmgr
#qmgr     unix  n       -       n       300     1       oqmgr
tlsmgr    unix  -       -       n       1000?   1       tlsmgr
rewrite   unix  -       -       n       -       -       trivial-rewrite
bounce    unix  -       -       n       -       0       bounce
defer     unix  -       -       n       -       0       bounce
trace     unix  -       -       n       -       0       bounce
verify    unix  -       -       n       -       1       verify
flush     unix  n       -       n       1000?   0       flush
proxymap  unix  -       -       n       -       -       proxymap
proxywrite unix -       -       n       -       1       proxymap
smtp      unix  -       -       n       -       -       smtp
relay     unix  -       -       n       -       -       smtp
#       -o smtp_helo_timeout=5 -o smtp_connect_timeout=5
showq     unix  n       -       n       -       -       showq
error     unix  -       -       n       -       -       error
retry     unix  -       -       n       -       -       error
discard   unix  -       -       n       -       -       discard
local     unix  -       n       n       -       -       local
virtual   unix  -       n       n       -       -       virtual
lmtp      unix  -       -       n       -       -       lmtp
anvil     unix  -       -       n       -       1       anvil
scache    unix  -       -       n       -       1       scache
#
# ====================================================================
# Interfaces to non-Postfix software. Be sure to examine the manual
# pages of the non-Postfix software to find out what options it wants.
#
# Many of the following services use the Postfix pipe(8) delivery
# agent.  See the pipe(8) man page for information about ${recipient}
# and other message envelope options.
# ====================================================================
#
# maildrop. See the Postfix MAILDROP_README file for details.
# Also specify in main.cf: maildrop_destination_recipient_limit=1
#
#maildrop  unix  -       n       n       -       -       pipe
#  flags=DRhu user=vmail argv=/usr/local/bin/maildrop -d ${recipient}
#
# ====================================================================
#
# Recent Cyrus versions can use the existing "lmtp" master.cf entry.
#
# Specify in cyrus.conf:
#   lmtp    cmd="lmtpd -a" listen="localhost:lmtp" proto=tcp4
#
# Specify in main.cf one or more of the following:
#  mailbox_transport = lmtp:inet:localhost
#  virtual_transport = lmtp:inet:localhost
#
# ====================================================================
#
# Cyrus 2.1.5 (Amos Gouaux)
# Also specify in main.cf: cyrus_destination_recipient_limit=1
#
#cyrus     unix  -       n       n       -       -       pipe
#  user=cyrus argv=/usr/lib/cyrus-imapd/deliver -e -r ${sender} -m ${extension} ${user}
#
# ====================================================================
#
# Old example of delivery via Cyrus.
#
#old-cyrus unix  -       n       n       -       -       pipe
#  flags=R user=cyrus argv=/usr/lib/cyrus-imapd/deliver -e -m ${extension} ${user}
#
# ====================================================================
#
# See the Postfix UUCP_README file for configuration details.
#
#uucp      unix  -       n       n       -       -       pipe
#  flags=Fqhu user=uucp argv=uux -r -n -z -a$sender - $nexthop!rmail ($recipient)
#
# ====================================================================
#
# Other external delivery methods.
#
#ifmail    unix  -       n       n       -       -       pipe
#  flags=F user=ftn argv=/usr/lib/ifmail/ifmail -r $nexthop ($recipient)
#
#bsmtp     unix  -       n       n       -       -       pipe
#  flags=Fq. user=bsmtp argv=/usr/local/sbin/bsmtp -f $sender $nexthop $recipient
#
#scalemail-backend unix -       n       n       -       2       pipe
#  flags=R user=scalemail argv=/usr/lib/scalemail/bin/scalemail-store
#  ${nexthop} ${user} ${extension}
#
#mailman   unix  -       n       n       -       -       pipe
#  flags=FR user=list argv=/usr/lib/mailman/bin/postfix-to-mailman.py
#  ${nexthop} ${user}
```

Postfixを構成する各種プロセスの動作を設定

詳細割愛


### Postfixの制御 ###

- `postfix`コマンド
  - `start`, `stop`サブコマンド: `systemctl`とおなじ
  - `flush`: メールキュー全送信
  - etc.
- `/etc/init.d/postfix`起動スクリプト
- `systmctl * postfix`



## 13.1.4 メールのリレー ##

- 踏み台にされないよう、デフォルト設定でリレー禁止
- 許可したいドメイン・LANのメールのみリレー許可するとよい

```
#mynetworks = 168.100.189.0/28, 127.0.0.0/8
#mynetworks = $config_directory/mynetworks
#mynetworks = hash:/etc/postfix/network_table
```

```
mydestination = $myhostname, localhost.$mydomain, localhost
```




## 13.1.5 メールアエリアスのメール転送 ##

```sh
cat /etc/aliases
```

```
#
#  Aliases in this file will NOT be expanded in the header from
#  Mail, but WILL be visible over networks or from /bin/mail.
#
#	>>>>>>>>>>	The program "newaliases" must be run after
#	>> NOTE >>	this file is updated for any changes to
#	>>>>>>>>>>	show through to sendmail.
#

# Basic system aliases -- these MUST be present.
mailer-daemon:	postmaster
postmaster:	root

# General redirections for pseudo accounts.
bin:		root
daemon:		root
adm:		root
...
newsadm:	news
newsadmin:	news
usenet:		news
ftpadm:		ftp
ftpadmin:	ftp
ftp-adm:	ftp
ftp-admin:	ftp
www:		webmaster
...
```

抜粋

```
www:		webmaster
```

- `www`ユーザ宛のメールを`webmaster`ユーザに届ける
  - `www`ユーザがシステムに存在する必要はない
  - `www`ユーザがシステムに存在する場合、そのユーザはメールを受け取れなくなる

他書式

- `/path`
  - 指定のパスのファイルにメールのメッセージ追記
- `|command`
  - 指定のコマンドのSTDINに流し込む
- `user@domain`
  - 指定したメールアドレスへ転送
- `:include:/path`
  - パスに指定したファイルを別名として読み込む
  - 簡易メーリングリストとして使える


`newaliases`コマンドで反映 (管理者権限)

```sh
newaliases
```

```
postalias: fatal: open /etc/aliases.db: Permission denied
```

```sh
sudo newaliases
```

```
空
```

`/etc/aliases.db`が更新される




### .forward ###

ホームディレクトリに `.forward`ファイルを配置することでメール転送できる

``` sh
vi .forward
```

```
test@mx.example.com
```




## 13.1.6 SMTPサーバの運用と管理 ##


### メールキュー ###

一瞬で空になるので実際に遊ぶことはかなわなかった

- メールキュー表示: `mailq`, `postqueue -p`
- メールキューをflushして全送信: `postqueue -f`, `postfix flush`
- メールキュー内のメール削除: `postsuper -d ${キュー内メールID}`, `postsuper -d ALL`

メールID: メールログ中で確認できる

```sh
sudo tail /var/log/maillog
```

```
...
Jan  4 14:45:00 lpic2-study-1 postfix/pickup[1554]: EE89219D757: uid=1000 from=<wand>
Jan  4 14:45:00 lpic2-study-1 postfix/cleanup[2097]: EE89219D757: message-id=<20210104144500.EE89219D757@lpic2-study-1.localdomain>
Jan  4 14:45:00 lpic2-study-1 postfix/qmgr[1555]: EE89219D757: from=<wand@lpic2-study-1.localdomain>, size=469, nrcpt=1 (queue active)
Jan  4 14:45:01 lpic2-study-1 postfix/local[2099]: EE89219D757: to=<wand@localhost.localdomain>, orig_to=<wand@localhost>, relay=local, delay=0.04, delays=0.03/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Jan  4 14:45:01 lpic2-study-1 postfix/qmgr[1555]: EE89219D757: removed
```

`EE89219D757` -- これ



### メールボックス ###

- mbox形式では`/var/mail/`を使用する
- `/var/spool/mail/`へのsymlink



``` sh
ls -lF /var/mail
```

```
lrwxrwxrwx. 1 root root 10 Nov 10 18:06 /var/mail -> spool/mail/
```

空であることを確認

``` sh
ls -l /var/mail/
```

```
total 0
```

ローカルでメール送信してみる

``` sh
mail wand@localhost
Subject: sample
sample body
.
EOT
```

メールログ確認

```sh
sudo tail /var/log/maillog
```

```
...
Jan  4 14:45:00 lpic2-study-1 postfix/pickup[1554]: EE89219D757: uid=1000 from=<wand>
Jan  4 14:45:00 lpic2-study-1 postfix/cleanup[2097]: EE89219D757: message-id=<20210104144500.EE89219D757@lpic2-study-1.localdomain>
Jan  4 14:45:00 lpic2-study-1 postfix/qmgr[1555]: EE89219D757: from=<wand@lpic2-study-1.localdomain>, size=469, nrcpt=1 (queue active)
Jan  4 14:45:01 lpic2-study-1 postfix/local[2099]: EE89219D757: to=<wand@localhost.localdomain>, orig_to=<wand@localhost>, relay=local, delay=0.04, delays=0.03/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Jan  4 14:45:01 lpic2-study-1 postfix/qmgr[1555]: EE89219D757: removed
```

> status=sent (delivered to mailbox)

メールボックス確認

```sh
ls -l /var/mail/
```

```
total 4
-rw-------. 1 wand mail 636 Jan  4 14:45 wand
```


1ユーザ1ファイル (mbox形式)

---


PostfixではMaildir形式も利用可能

```diff
--- /etc/postfix/main.cf.bak	2021-01-04 15:00:39.443019718 +0000
+++ /etc/postfix/main.cf	2021-01-04 15:01:29.182193645 +0000
@@ -416,7 +416,7 @@
 # "Maildir/" for qmail-style delivery (the / is required).
 #
 #home_mailbox = Mailbox
-#home_mailbox = Maildir/
+home_mailbox = Maildir/
  
 # The mail_spool_directory parameter specifies the directory where
 # UNIX-style mailboxes are kept. The default setting depends on the
```

設定反映

``` sh
sudo postfix reload
```

```
postfix/postfix-script: refreshing the Postfix mail system
```


メール送信してみる

``` sh
mail wand@localhost
Subject: maildir sample
sample body
.
EOT
```

メールログ確認

``` sh
sudo tail /var/log/maillog
```

```
...
Jan  4 15:02:44 lpic2-study-1 postfix/pickup[2468]: 3FFDB19D757: uid=1000 from=<wand>
Jan  4 15:02:44 lpic2-study-1 postfix/cleanup[2478]: 3FFDB19D757: message-id=<20210104150244.3FFDB19D757@lpic2-study-1.localdomain>
Jan  4 15:02:44 lpic2-study-1 postfix/qmgr[2469]: 3FFDB19D757: from=<wand@lpic2-study-1.localdomain>, size=477, nrcpt=1 (queue active)
Jan  4 15:02:44 lpic2-study-1 postfix/local[2480]: 3FFDB19D757: to=<wand@localhost.localdomain>, orig_to=<wand@localhost>, relay=local, delay=0.05, delays=0.03/0.01/0/0, dsn=2.0.0, status=sent (delivered to maildir)
Jan  4 15:02:44 lpic2-study-1 postfix/qmgr[2469]: 3FFDB19D757: removed
```

> status=sent (delivered to maildir)

``` sh
ls -l ~wand/Maildir
```

```
total 0
drwx------. 2 wand wand  6 Jan  4 15:02 cur
drwx------. 2 wand wand 58 Jan  4 15:02 new
drwx------. 2 wand wand  6 Jan  4 15:02 tmp
```

``` sh
file ~wand/Maildir/new/1609772564.V802I21fdadaM288972.lpic2-study-1
```

```
/home/wand/Maildir/new/1609772564.V802I21fdadaM288972.lpic2-study-1: SMTP mail, ASCII text
```

```sh
cat ~wand/Maildir/new/1609772564.V802I21fdadaM288972.lpic2-study-1
```

```
Return-Path: <wand@lpic2-study-1.localdomain>
X-Original-To: wand@localhost
Delivered-To: wand@localhost.localdomain
Received: by lpic2-study-1.localdomain (Postfix, from userid 1000)
	id 3FFDB19D757; Mon,  4 Jan 2021 15:02:44 +0000 (UTC)
Date: Mon, 04 Jan 2021 15:02:44 +0000
To: wand@localhost.localdomain
Subject: maildir sample
User-Agent: Heirloom mailx 12.5 7/5/10
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Transfer-Encoding: 7bit
Message-Id: <20210104150244.3FFDB19D757@lpic2-study-1.localdomain>
From: wand@lpic2-study-1.localdomain

sample body
```

- メールが届いた
- 1メール1ファイル


# 13.2 メールのフィルタリング #

## 13.2.1 Sieveの設定 ##

Dovecotと連携して、POP/IMAPサーバ側でメールのフィルタリングを行うプログラミング言語

- `dovecot-pigeonhole`パッケージ
- ubuntuの場合は`dovecot-sieve`

``` sh
sudo yum -y install dovecot dovecot-pigeonhole
```


ArchWiki -- Dovecot https://wiki.archlinux.jp/index.php/Dovecot#Sieve

Sieveプログラムサンプル https://wiki.dovecot.org/Pigeonhole/Sieve/Examples

```
require ["fileinto", "envelope"];
if address :is "to" "dovecot@dovecot.org" {
  fileinto "Dovecot-list";
} elsif envelope :is "from" "owner-cipe-l@inka.de" {
  fileinto "lists.cipe";
} elsif anyof (header :contains "X-listname" "lugog@cip.rz.fh-offenburg.de",
               header :contains "List-Id" "Linux User Group Offenburg") {
  fileinto "ml.lugog";
} else {
  # The rest goes into INBOX
  # default is "implicit keep", we do it explicitly here
  keep;
}
```

- 宛先が`dovecot@dovecot.org`なら`Dovecot-list`メールフォルダに保存
- エンベロープfromが`owner-cipe-l@inka.de`からなら `lists.cipe`メールフォルダに保存
- ヘッダが次のいずれかを満たしたら `ml.lugog` メールフォルダに保存
  - `X-listname`が`lugog@cip.rz.fh-offenburg.de`
  - `List-Id`が`Linux User Group Offenburg`

のような振り分けができる

## 13.2.2 Procmailの設定 ##

procmailを用いて、MDAレイヤーでフィルタリングできる

cf. dovecot-sieveはPOP/IMAPのレイヤーでフィルタリング


```sh
sudo yum -y install procmail
```

`.procmailrc`ファイルをホームディレクトリの下に配置

``` sh
cat ~/.procmailrc
```

```
SHELL=/bin/bash
PATH=$HOME/bin:/usr/bin:/usr/local/bin
MAILDIR=$HOME/Maildir/
DEFAULT=$MAILDIR
LOGFILE=$MAILDIR/procmail.log

:0
* ^Subject:.*SPAM.*
/dev/null
```

- Maildir/形式での保存先
- 正規表現ベースの仕分けルール定義
  - 「レシピ」という。3行構成

今回は件名(Subject)に`SPAM`という文字列が含まれるメールを`/dev/null`に捨てるレシピを定義した

postfixのprocmail連携設定を行う

```sh
which procmail
```

```
/usr/bin/procmail
```

```diff
--- /etc/postfix/main.cf.bak	2021-01-04 15:58:57.605572567 +0000
+++ /etc/postfix/main.cf	2021-01-04 15:59:21.376567341 +0000
@@ -444,7 +444,7 @@
 # IF YOU USE THIS TO DELIVER MAIL SYSTEM-WIDE, YOU MUST SET UP AN
 # ALIAS THAT FORWARDS MAIL FOR ROOT TO A REAL USER.
 #
-#mailbox_command = /some/where/procmail
+mailbox_command = /usr/bin/procmail
 #mailbox_command = /some/where/procmail -a "$EXTENSION"
 
 # The mailbox_transport specifies the optional transport in master.cf
```

設定反映


``` sh
sudo postfix check
sudo postfix reload
```

まず、件名にSPAMを含まないメールを送ってみる

``` sh
mail wand@localhost
Subject: boo
sample
.
EOT
```

```sh
ls -lR ~/Maildir
```

```
/home/wand/Maildir:
total 4
drwx------. 2 wand wand   6 Jan  4 15:02 cur
drwx------. 2 wand wand  97 Jan  4 16:05 new
-rw-------. 1 wand wand 149 Jan  4 16:05 procmail.log
drwx------. 2 wand wand   6 Jan  4 16:05 tmp

/home/wand/Maildir/cur:
total 0

/home/wand/Maildir/new:
total 8
-rw-------. 1 wand wand 581 Jan  4 15:02 1609772564.V802I21fdadaM288972.lpic2-study-1
-rw-------. 1 wand wand 565 Jan  4 16:05 1609776326.3427_0.lpic2-study-1

/home/wand/Maildir/tmp:
total 0
```

ちゃんと届いた

今度はSPAMとして捨てられるはずのメールを送信してみる

``` sh
mail wand@localhost
Subject: [SPAM] boo
sample
.
EOT
```

- MTU的にはあくまでメールのリレーを完了している
- スパムの仕分けはMDUであるprocmailの管轄
- なのでprocmailのログを見てみる

``` sh
tail -f ~/Maildir/procmail.log
```

```
From wand@lpic2-study-1.localdomain  Mon Jan  4 16:05:26 2021
 Subject: boo
  Folder: /home/wand/Maildir/new/1609776326.3427_0.lpic2-study-1	    565
From wand@lpic2-study-1.localdomain  Mon Jan  4 16:06:53 2021
 Subject: [SPAM] boo
  Folder: /dev/null							    634
```

2通目は正しく`/dev/null`に捨てていることを確認


``` sh
ls -lR ~/Maildir
```

```
/home/wand/Maildir:
total 4
drwx------. 2 wand wand   6 Jan  4 15:02 cur
drwx------. 2 wand wand  97 Jan  4 16:05 new
-rw-------. 1 wand wand 266 Jan  4 16:06 procmail.log
drwx------. 2 wand wand   6 Jan  4 16:05 tmp

/home/wand/Maildir/cur:
total 0

/home/wand/Maildir/new:
total 8
-rw-------. 1 wand wand 581 Jan  4 15:02 1609772564.V802I21fdadaM288972.lpic2-study-1
-rw-------. 1 wand wand 565 Jan  4 16:05 1609776326.3427_0.lpic2-study-1

/home/wand/Maildir/tmp:
total 0
```

実際、2通目のメールが配送されていないことも確認できた。OK


# 13.3 POPとIMAP #

MUAがメールボックスからメールを取り出すときに使う


## 13.3.1 Dovecotの利用 ##

Dovecot: POP3,IMAP4, POP3S,IMAPS (over SSL/TLS)対応のMDA


- POP3: 110
- IMAP: 143
- POP3 over SSL/TLS (POP3S): 995
- IMAP over SSL/TLS (IMAPS): 993



``` sh
sudo yum -y install dovecot

sudo systemctl start dovecot
```

### 設定 ###

設定ファイル `dovecot.conf`から `conf.d/`以下の設定ファイルを読み込んでいる

```sh
cat /etc/dovecot/dovecot.conf
```

```
...
# Most of the actual configuration gets included below. The filenames are
# first sorted by their ASCII value and parsed in that order. The 00-prefixes
# in filenames are intended to make it easier to understand the ordering.
!include conf.d/*.conf
```


```sh
ls /etc/dovecot/conf.d/
```

```
10-auth.conf	  15-mailboxes.conf    90-quota.conf		    auth-master.conf.ext
10-director.conf  20-imap.conf	       90-sieve-extprograms.conf    auth-passwdfile.conf.ext
10-logging.conf   20-lmtp.conf	       90-sieve.conf		    auth-sql.conf.ext
10-mail.conf	  20-managesieve.conf  auth-checkpassword.conf.ext  auth-static.conf.ext
10-master.conf	  20-pop3.conf	       auth-deny.conf.ext	    auth-system.conf.ext
10-ssl.conf	  90-acl.conf	       auth-dict.conf.ext	    auth-vpopmail.conf.ext
15-lda.conf	  90-plugin.conf       auth-ldap.conf.ext
```

- 使用するプロトコルはdovecot.confで設定する

``` sh
cat /etc/dovecot/dovecot.conf
```

```
...
# Protocols we want to be serving.
#protocols = imap pop3 lmtp
...
```

LMTP: Local Mail Transfer Protocol

---


認証メカニズム

``` sh
cat /etc/dovecot/conf.d/10-auth.conf
```

```
...
# Space separated list of wanted authentication mechanisms:
#   plain login digest-md5 cram-md5 ntlm rpa apop anonymous gssapi otp skey
#   gss-spnego
# NOTE: See also disable_plaintext_auth setting.
auth_mechanisms = plain
...
```

メールの配送形式と場所

- mbox/maildir
- ディレクトリパス

```sh
cat /etc/dovecot/conf.d/10-mail.conf
```

```
...
# Location for users' mailboxes. The default is empty, which means that Dovecot
# tries to find the mailboxes automatically. This won't work if the user
# doesn't yet have any mail, so you should explicitly tell Dovecot the full
# location.
#
# If you're using mbox, giving a path to the INBOX file (eg. /var/mail/%u)
# isn't enough. You'll also need to tell Dovecot where the other mailboxes are
# kept. This is called the "root mail directory", and it must be the first
# path given in the mail_location setting.
#
# There are a few special variables you can use, eg.:
#
#   %u - username
#   %n - user part in user@domain, same as %u if there's no domain
#   %d - domain part in user@domain, empty if there's no domain
#   %h - home directory
#
# See doc/wiki/Variables.txt for full list. Some examples:
#
#   mail_location = maildir:~/Maildir
#   mail_location = mbox:~/mail:INBOX=/var/mail/%u
#   mail_location = mbox:/var/mail/%d/%1n/%n:INDEX=/var/indexes/%d/%1n/%n
#
# <doc/wiki/MailLocation.txt>
#
#mail_location = 
...
```

POP3S, IMAPSのSSL/TLS関連

```sh
cat /etc/dovecot/conf.d/10-ssl.conf
```


```
...
##
## SSL settings
##

# SSL/TLS support: yes, no, required. <doc/wiki/SSL.txt>
# disable plain pop3 and imap, allowed are only pop3+TLS, pop3s, imap+TLS and imaps
# plain imap and pop3 are still allowed for local connections
ssl = required

# PEM encoded X.509 SSL/TLS certificate and private key. They're opened before
# dropping root privileges, so keep the key file unreadable by anyone but
# root. Included doc/mkcert.sh can be used to easily generate self-signed
# certificate, just make sure to update the domains in dovecot-openssl.cnf
ssl_cert = </etc/pki/dovecot/certs/dovecot.pem
ssl_key = </etc/pki/dovecot/private/dovecot.pem
...
```



`doveconf`コマンド: デフォルト設定含めパラメータ出力

cf. postconfは設定ファイルで指定の設定のみ出力

``` sh
doveconf
```

```
# 2.2.36 (1f10bfa63): /etc/dovecot/dovecot.conf
# Pigeonhole version 0.4.24 (124e06aa)
# OS: Linux 3.10.0-1127.19.1.el7.x86_64 x86_64 CentOS Linux release 7.8.2003 (Core) 
# Hostname: lpic2-study-1.asia-northeast1-b.c.lpic2-study.internal
# NOTE: Send doveconf -n output instead when asking for help.
auth_anonymous_username = anonymous
auth_cache_negative_ttl = 1 hours
auth_cache_size = 0
auth_cache_ttl = 1 hours
auth_cache_verify_password_with_worker = no
auth_debug = no
auth_debug_passwords = no
...
```

### 接続確認 ###

telnetでPOP接続確認


```sh
telnet localhost 110
```

```
Trying ::1...
Connected to localhost.
Escape character is '^]'.
+OK Dovecot ready.
USER wand
+OK
PASS ...
+OK Logged in.
LIST
+OK 2 messages:
1 597
2 581
.
QUIT
+OK Logging out.
Connection closed by foreign host.
```

### 管理コマンド -- doveadm ###

`doveadm reload`: 設定反映

``` sh
sudo doveadm reload
```

`doveadm log find` ログファイルのパス確認


``` sh
sudo doveadm log find
```

```
Looking for log files from /var/log
Debug: /var/log/maillog
Info: /var/log/maillog
Warning: /var/log/maillog
Error: /var/log/maillog
Fatal: /var/log/maillog
```

`doveadm log test`: 各種ログレベルのテストログ出力

``` sh
sudo doveadm log test

sudo tail /var/log/maillog
```

```
Jan  4 16:57:28 lpic2-study-1 dovecot: doveadm: Debug: This is Dovecot's debug log (1609779448)
Jan  4 16:57:28 lpic2-study-1 dovecot: doveadm: This is Dovecot's info log (1609779448)
Jan  4 16:57:28 lpic2-study-1 dovecot: doveadm: Warning: This is Dovecot's warning log (1609779448)
Jan  4 16:57:28 lpic2-study-1 dovecot: doveadm: Error: This is Dovecot's error log (1609779448)
Jan  4 16:57:28 lpic2-study-1 dovecot: doveadm: Fatal: This is Dovecot's fatal log (1609779448)
```

`doveadm pw`: パスワードのハッシュ値生成

``` sh
sudo doveadm pw
```

```
Enter new password: 
Retype new password: 
{CRAM-MD5}00747cf2ffaf11c5ea4a64979c3901fc1d20dee13f480bb598f7d8575b23e61b
```

`doveadm stop`: dovecotプロセス停止

``` sh
sudo doveadm stop
```


### Column: Courier IMAP ###

POP/IMAP対応

MTAも兼ねる(Courier-MTA)が、単独のPOP/IMAPサーバとしても利用可能
