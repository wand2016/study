---
title: LPIC201/202 あずき本 ch1 キャパシティプランニング
tags:
- LPIC201
- 勉強メモ
- 資格勉強
date: 2020-12-01T23:13:00+09:00
bibliography: https://www.shoeisha.co.jp/book/detail/9784798151250
---

章末問題から解く感じで進めてみる

# Do I Know This Already? #

## 1 キャパシティプランニングを行う際に測定すべきもの/測定する意味のないもの ##

- 測定すべきもの
  - swap使用率
  - メモリの使用率
  - ネットワークのトラフィック
  - CPUの使用率
- 測定する意味のないもの
    - swap領域サイズ
        - 設定したとおりの容量。勝手に増えたりしないので


## 2 スワップ領域の使用量計測 ##

```sh
vmstat
cat /proc/swaps
free
```

## 3 vmstatコマンドの出力の読み方 ##

- vmstatではネットワーク利用状況は把握できない
- us, sy, id, wa でCPU使用状況を把握する
- 例: idが0、usが0、syが10くらい、waが90くらい
  - CPUアイドル時間(id)が0になっている
  - 要因はユーザーアプリケーション(us)やシステム(sy)ではなくI/O待ち(wa)による
- free, buff, cacheでメモリ使用状況を把握する
- swpd, si, so, bi, boでスワップ使用状況を把握する
- 例: swpdが大きく、si, so, bi, boが0でない
  - スワップ領域が使用されており、スワップイン(si)・スワップアウト(so)、ディスクI/O(bi,bo)が常に発生している


## 4 sarの出力ファイル名、記録閲覧 ##

```sh
sar -b -f /var/log/sa/saXX
```

XXは2桁の日付


## 5 vmstatコマンドのオプション・表示内容 ##

```
Usage:
 vmstat [options] [delay [count]]
```

```sh
vmstat 1 3
```

```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 23443260 351512 917396    0    0     3    14   50  120  1  0 99  0  0
 0  0      0 23443252 351512 917412    0    0     0     0   85  231  0  0 100  0  0
 0  0      0 23443252 351512 917412    0    0     0     0   71  201  0  0 100  0  0
```

- 1秒間隔で3回
- スワップ領域、バッファキャッシュ、ページキャッシュ等の**利用状況**を確認できる
- 搭載しているメモリ**総容量は確認できない**
  - `/proc/meminfo`で確認できる


```sh
cat /proc/meminfo 
```

```
MemTotal:       26212040 kB
...
```

## 6 プロセスごとのメモリ使用量を把握し、CPU消費の大きいものを特定するには ##

```sh
top
ps aux
```


## 7 sarの出力する統計情報をTSVで出力するには ##

- sadc
  - システム状況を収集し、ログに書き込む人
- sar
  - 収集データを表示する人
- sadf
  - ログをTSV, XML, JSON等で出力



# 1.1 キャパシティプランニング #

## 1.1.1 キャパシティプランニングとは ##

- コストを抑えつつリソース不足にもならないよう見積もる
- システムのリソースを見積もる場合、個々のプログラムの計測値のボトムアップで求める
- パフォーマンスチューニングのためにも計測は重要


# 1.2 リソース使用率の測定とトラブルシューティング #

## 1.2.1 総合的なリソース使用率の測定 ##

### top ###

``` sh
top
```


```
top - 13:50:56 up 2 min,  1 user,  load average: 0.01, 0.01, 0.01
Tasks:  89 total,   1 running,  88 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  5.9 sy,  0.0 ni, 94.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  1013796 total,   692376 free,   183388 used,   138032 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   687820 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND             
    1 root      20   0  127984   6612   4136 S   0.0  0.7   0:01.62 systemd             
    2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd            
    3 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0         
    4 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H        
    5 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kworker/u4:0        
    6 root      20   0       0      0      0 S   0.0  0.0   0:00.01 ksoftirqd/0         
    7 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 migration/0         
...
```


#### 1行目から読み取れる情報 ####


```
top - 13:50:56 up 2 min,  1 user,  load average: 0.01, 0.01, 0.01
```

- 現在時刻
- 起動してからの経過時間
- ログイン中のユーザ数
- 平均負荷 (1, 5, 15分間の平均)



平均負荷(load average)はcpuのコア数を超えていないことが目安

```sh
grep processor /proc/cpuinfo | wc -l
```

```
2
```


```sh
grep cpu.cores /proc/cpuinfo
```

```
cpu cores	: 1
cpu cores	: 1
```

論理CPU2つ、それぞれ1コアなので、この場合2を超えていないことが目安

#### 2行目から読み取れる情報 ####


```
Tasks:  89 total,   1 running,  88 sleeping,   0 stopped,   0 zombie
```

- 総プロセス数
- 実行状態
- スリープ状態
- 停止状態
- ゾンビ状態
  - 終了し、親プロセスのwaitを待っている子プロセス
  - forkされるとプロセステーブルに追加される
  - 親のwaitをもって子はプロセステーブルから削除される
  - つまり、親にwaitで引き取られない限りプロセステーブルから削除されずこれになる

#### 3行目から読み取れる情報 ####

```
%Cpu(s):  0.0 us,  5.9 sy,  0.0 ni, 94.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
```

- us: user
- sy: system
- ni: nice
- id: idle
- wa: wait
- hi: hardware irq
- si: sofrware irq
- st: steal

【補】vmstatのcpu部分とかぶる

```sh
vmstat
```

```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 615412    244 213332    0    0    48    25   26   34  0  0 99  0  0
```


#### 4,5行目から読み取れる情報 ####

```
KiB Mem :  1013796 total,   614924 free,   185180 used,   213692 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   682628 avail Mem 
```

【補】vmstatのmemory部分とかぶる

```sh
vmstat
```

```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 615280    244 213472    0    0    44    23   25   33  0  0 99  0  0
```


#### のこり ####


```
  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND           
    1 root      20   0  127984   6612   4136 S   0.0  0.7   0:01.71 systemd           
    2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd          
    4 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H      
    6 root      20   0       0      0      0 S   0.0  0.0   0:00.01 ksoftirqd/0       
```

`f`: 表示項目を切替できる


```
Fields Management for window 1:Def, whose current sort field is %CPU
   Navigate with Up/Dn, Right selects for move then <Enter> or Left commits,
   'd' or <Space> toggles display, 's' sets sort.  Use 'q' or <Esc> to end!

* PID     = Process Id             PGRP    = Process Group Id       vMj     = Major Faults delta
* USER    = Effective User Name    TTY     = Controlling Tty        vMn     = Minor Faults delta
* PR      = Priority               TPGID   = Tty Process Grp Id     USED    = Res+Swap Size (KiB)
* NI      = Nice Value             SID     = Session Id             nsIPC   = IPC namespace Inode
* VIRT    = Virtual Image (KiB)    nTH     = Number of Threads      nsMNT   = MNT namespace Inode
* RES     = Resident Size (KiB)    P       = Last Used Cpu (SMP)    nsNET   = NET namespace Inode
* SHR     = Shared Memory (KiB)    TIME    = CPU Time               nsPID   = PID namespace Inode
* S       = Process Status         SWAP    = Swapped Size (KiB)     nsUSER  = USER namespace Inode
* %CPU    = CPU Usage              CODE    = Code Size (KiB)        nsUTS   = UTS namespace Inode
* %MEM    = Memory Usage (RES)     DATA    = Data+Stack (KiB)
* TIME+   = CPU Time, hundredths   nMaj    = Major Page Faults
* COMMAND = Command Name/Line      nMin    = Minor Page Faults
  PPID    = Parent Process pid     nDRT    = Dirty Pages Count
  UID     = Effective User Id      WCHAN   = Sleeping in Function
  RUID    = Real User Id           Flags   = Task Flags <sched.h>
  RUSER   = Real User Name         CGROUPS = Control Groups
  SUID    = Saved User Id          SUPGIDS = Supp Groups IDs
  SUSER   = Saved User Name        SUPGRPS = Supp Groups Names
  GID     = Group Id               TGID    = Thread Group Id
  GROUP   = Group Name             ENVIRON = Environment vars
```

`l`: 1行目(load averageの行)表示非表示

`t`: 2,3行目(プロセス、CPU状態)表示非表示

`m`: 4,5行目(Mem, Swapの行)表示形式切り替え

数値

```
KiB Mem :  1013796 total,   607248 free,   188852 used,   217696 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   678908 avail Mem
```

グラフ1

```
KiB Mem : 33.0/1013796  [||||||||||||||||||||||||||||||                                                              ]
KiB Swap:  0.0/0        [                                                                                            ]
```

グラフ2 (塗りつぶしっぽいやつ。うまくコピペできなかった)

```
KiB Mem : 33.0/1013796  [                                                                                            ]
KiB Swap:  0.0/0        [                                                                                            ]
```

非表示

```
```

`u`: 指定のユーザのプロセスのみ表示

```
top - 14:33:44 up 45 min,  2 users,  load average: 0.00, 0.01, 0.01
Tasks:  89 total,   1 running,  88 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  1013796 total,   607272 free,   188828 used,   217696 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   678932 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND           
 1251 wand      20   0  156784   2408   1072 S   0.0  0.2   0:00.02 sshd              
 1252 wand      20   0  115512   1888   1512 S   0.0  0.2   0:00.02 bash              
 1436 wand      20   0  156784   2552   1188 S   0.0  0.3   0:00.09 sshd              
 1437 wand      20   0  115516   1936   1532 S   0.0  0.2   0:00.03 bash              
 1506 wand      20   0  159896   2140   1520 R   0.0  0.2   0:00.00 top               
```

ソート

| キーストローク | ソート項目                |
|----------------|---------------------------|
| `P`            | CPU使用率                 |
| `M`            | メモリ使用率              |
| `T`            | 起動時間順                |
| `<`/`>`        | ソート項目を左/右のものに |


`W`: Write. 現在の設定を~/.toprcに保存

`k`: kill. シグナル送信

`A`: 表示モード切り替え

```
1  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND         
   869 root      20   0  119704  20780   8048 S   0.3  2.0   0:01.07 google_osconfig 
     1 root      20   0  127984   6612   4136 S   0.0  0.7   0:01.75 systemd         
     2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd        
     4 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H    
     6 root      20   0       0      0      0 S   0.0  0.0   0:00.01 ksoftirqd/0     
     7 root      rt   0       0      0      0 S   0.0  0.0   0:00.00 migration/0     
     8 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcu_bh          
2  PID  PPID     TIME+  %CPU %MEM  PR  NI S    VIRT    RES   UID COMMAND             
  1585  1252   0:00.04   0.0  0.2  20   0 R  159896   2080  1000 top                 
  1584  1437   0:00.07   0.0  0.2  20   0 S  159896   2052  1000 top                 
  1582     2   0:00.00   0.0  0.0  20   0 S       0      0     0 kworker/1:1         
  1580  1575   0:00.00   0.0  0.1  30  10 S  113640    972     0 awk                 
  1579  1575   0:00.16   0.0  2.1  30  10 S  351600  21776     0 yum-cron            
  1575  1314   0:00.00   0.0  0.1  30  10 S  113280   1472     0 run-parts           
  1567     2   0:00.00   0.0  0.0  20   0 S       0      0     0 kworker/1:0         
3  PID %MEM    VIRT    RES   CODE    DATA    SHR nMaj nDRT  %CPU COMMAND             
...
```

`d`,`s`: delay.更新間隔偏光

`h`,`?`: ヘルプ表示

```
Help for Interactive Commands - procps-ng version 3.3.10
Window 1:Def: Cumulative mode Off.  System: Delay 3.0 secs; Secure mode Off.

  Z,B,E,e   Global: 'Z' colors; 'B' bold; 'E'/'e' summary/task memory scale
  l,t,m     Toggle Summary: 'l' load avg; 't' task/cpu stats; 'm' memory info
  0,1,2,3,I Toggle: '0' zeros; '1/2/3' cpus or numa node views; 'I' Irix mode
  f,F,X     Fields: 'f'/'F' add/remove/order/sort; 'X' increase fixed-width

  L,&,<,> . Locate: 'L'/'&' find/again; Move sort column: '<'/'>' left/right
  R,H,V,J . Toggle: 'R' Sort; 'H' Threads; 'V' Forest view; 'J' Num justify
  c,i,S,j . Toggle: 'c' Cmd name/line; 'i' Idle; 'S' Time; 'j' Str justify
  x,y     . Toggle highlights: 'x' sort field; 'y' running tasks
  z,b     . Toggle: 'z' color/mono; 'b' bold/reverse (only if 'x' or 'y')
  u,U,o,O . Filter by: 'u'/'U' effective/any user; 'o'/'O' other criteria
  n,#,^O  . Set: 'n'/'#' max tasks displayed; Show: Ctrl+'O' other filter(s)
  C,...   . Toggle scroll coordinates msg for: up,down,left,right,home,end

  k,r       Manipulate tasks: 'k' kill; 'r' renice
  d or s    Set update interval
  W,Y       Write configuration file 'W'; Inspect other output 'Y'
  q         Quit
          ( commands shown with '.' require a visible task display window ) 
Press 'h' or '?' for help with Windows,
```

`q`: 終了



### vmstat ###

```sh
vmstat 1 3
```

```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 590112    244 219340    0    0    23    12   19   27  0  0 100  0  0
 0  0      0 590088    244 219340    0    0     0     0   22   27  0  0 100  0  0
 0  0      0 590088    244 219340    0    0     0     0   18   38  0  0 100  0  0
```

- procs
    - r: 実行待ちプロセス数
    - b: 割り込み不可能なスリープ状態にあるプロセス数
      - 0であることが望ましい
      - 0以外の値が多く見られる場合、何らかの対処が必要
- system
  - in: interrupts per second (クロック割り込み含む)
  - cs: context switches per second


### iostat ###

#### インストール ####

```sh
iostat
```

ない

```
-bash: iostat: command not found
```

iostatを含むパッケージをyumで調べる

```sh
yum provides iostat
```

```
Failed to set locale, defaulting to C
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: ty1.mirror.newmediaexpress.com
 * epel: d2lzkl7pfhq30w.cloudfront.net
 * extras: ty1.mirror.newmediaexpress.com
 * updates: ty1.mirror.newmediaexpress.com
sysstat-10.1.5-19.el7.x86_64 : Collection of performance monitoring tools for Linux
Repo        : base
Matched from:
Filename    : /usr/bin/iostat
```

sysstat

```
sysstat-10.1.5-19.el7.x86_64 : Collection of performance monitoring tools for Linux
```

入れる

```sh
sudo yum install -y sysstat
iostat
```

入った

```
Linux 3.10.0-1127.19.1.el7.x86_64 (lpic2-study-1) 	12/01/20 	_x86_64_	(2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.34    0.00    0.15    0.18    0.00   99.32

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               4.10       219.57       263.64     977897    1174136
```

他にもいろいろ入ったっぽい

```sh
yum info sysstat
```


```
Installed Packages
Name        : sysstat
...
Description : The sysstat package contains sar, sadf, mpstat, iostat, pidstat,
            : nfsiostat-sysstat, tapestat, cifsiostat and sa tools for Linux.
...
```

この後使う`sar`も入った


#### 使う ####

```sh
iostat --help
```

```
Usage: iostat [ options ] [ <interval> [ <count> ] ]
Options are:
[ -c ] [ -d ] [ -h ] [ -k | -m ] [ -N ] [ -t ] [ -V ] [ -x ] [ -y ] [ -z ]
[ -j { ID | LABEL | PATH | UUID | ... } ]
[ [ -T ] -g <group_name> ] [ -p [ <device> [,...] | ALL ] ]
[ <device> [...] | ALL ]
```

```sh
iostat 1 3
```

```
Linux 3.10.0-1127.19.1.el7.x86_64 (lpic2-study-1) 	12/01/20 	_x86_64_	(2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.34    0.00    0.15    0.18    0.00   99.32

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               4.12       223.96       247.69    1067817    1180948

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.00    0.00    0.00  100.00

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               0.00         0.00         0.00          0          0

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.00    0.00    0.00  100.00

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               0.00         0.00         0.00          0          0
```

2番目以降の表示は前回からの差分

CPU使用状況とディスクI/O関連の情報を監視できる

`cifsiostat`というのもある


## 1.2.2 CPU使用率の測定 ##




## 1.2.3 メモリおよびスワップ使用量の測定 ##


## 1.2.4 ディスク使用量の測定 ##



## 1.2.5 ネットワークトラフィックの測定 ##



# 1.3 リソース受容の分析と予測 #

## 1.3.1 リソース監視ツール ##

## 1.3.2 受容の分析と将来の予測 ##

## 1.3.3 リソースの問題解決 ##


